<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fire School System</title>
  
  <!-- CSS STYLES -->
  <style>
    :root { --primary-color: #0d6efd; --success-color: #198754; --secondary-color: #6c757d; --danger-color: #dc3545; --light-gray: #f8f9fa; --dark-gray: #343a40; --border-color: #dee2e6; --box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: var(--light-gray); margin: 0; color: var(--dark-gray); }
    .container { max-width: 1300px; margin: 20px auto; padding: 20px; background: #fff; border-radius: 8px; box-shadow: var(--box-shadow); }
    header { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--border-color); padding-bottom: 15px; margin-bottom: 20px; }
    header h1 { margin: 0; color: var(--primary-color); }
    .actions { display: flex; gap: 10px; }
    .btn { padding: 10px 18px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px; }
    .btn:hover { opacity: 0.9; } .btn:active { transform: scale(0.98); }
    .btn-primary { background-color: var(--primary-color); color: white; } .btn-success { background-color: var(--success-color); color: white; } .btn-secondary { background-color: var(--secondary-color); color: white; } .btn-danger { background-color: var(--danger-color); color: white; } .btn-edit { background-color: #ffc107; color: black; padding: 5px 10px; font-size: 12px; } .btn-delete { background-color: #dc3545; color: white; padding: 5px 10px; font-size: 12px; }
    .filters { display: flex; gap: 20px; margin-bottom: 20px; } .filter-group { display: flex; flex-direction: column; } .filter-group label { margin-bottom: 5px; font-size: 14px; font-weight: 500; }
    select, input[type="file"] { padding: 8px; border-radius: 5px; border: 1px solid var(--border-color); min-width: 200px; }
    .table-wrapper { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid var(--border-color); padding: 10px 12px; text-align: left; white-space: nowrap; }
    th { background-color: var(--primary-color); color: white; font-weight: 600; position: sticky; top: 0; }
    tbody tr:nth-child(even) { background-color: var(--light-gray); } tbody tr:hover { background-color: #e9ecef; }
    .action-cell { display: flex; gap: 8px; }
    .loader { border: 8px solid #f3f3f3; border-top: 8px solid var(--primary-color); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 40px auto; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .no-data-msg { text-align: center; color: #888; font-style: italic; padding: 40px; }
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
    .modal-content { background-color: #fefefe; margin: 5% auto; padding: 25px; border: 1px solid #888; width: 80%; max-width: 800px; border-radius: 8px; box-shadow: var(--box-shadow); }
    .close-btn { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
    #student-form { max-height: 60vh; overflow-y: auto; padding: 5px;}
    .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px; }
    .form-group { display: flex; flex-direction: column; } .form-group label { margin-bottom: 5px; font-size: 14px; }
    .form-group input, .form-group select { padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 14px; width: 100%; box-sizing: border-box; }
    .modal-actions { margin-top: 25px; text-align: right; }
    #export-checkbox-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; max-height: 350px; overflow-y: auto; border: 1px solid var(--border-color); padding: 15px; border-radius: 5px; margin-top: 15px; }
  </style>
</head>
<body>
  <!-- HTML BODY -->
  <div class="container">
    <header><h1>Fire School System</h1> <div class="actions"> <button id="add-student-btn" class="btn btn-primary">+ Add Student</button> <button id="bulk-add-btn" class="btn btn-success">Bulk Add</button> <button id="sort-export-btn" class="btn btn-secondary">Sort & Export</button> </div> </header>
    <div class="filters"> <div class="filter-group"> <label for="grade-select">Select Grade:</label> <select id="grade-select"></select> </div> <div class="filter-group"> <label for="section-select">Select Section:</label> <select id="section-select"></select> </div> </div>
    <div id="loader" class="loader"></div>
    <div id="data-container" style="display: none;"> <div class="table-wrapper"> <table id="student-table"> <thead></thead> <tbody></tbody> </table> </div> </div>
    <p id="no-data-msg" style="display: none;">Loading data...</p>
  </div>
  <!-- Student Modal -->
  <div id="student-modal" class="modal">
    <div class="modal-content">
      <span class="close-btn">&times;</span>
      <h2 id="modal-title">Add New Student</h2>
      <div id="student-form-container">
          <div class="form-grid">
            <!-- Inputs will be generated here by JavaScript -->
          </div>
      </div>
      <div class="modal-actions">
        <!-- SAVE BUTTON AB FORM KE ANDAR NAHI HAI, LEKIN HUM ISPAR DIRECT CLICK LISTENER LAGAYENGE -->
        <button id="save-student-btn" class="btn btn-primary">Save</button>
      </div>
    </div>
  </div>
  <!-- Other Modals -->
  <div id="bulk-modal" class="modal"> <!-- Bulk modal content... --> </div>
  <div id="export-modal" class="modal"> <!-- Export modal content... --> </div>

  <!-- Libraries -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

  <!-- JAVASCRIPT LOGIC -->
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBZB9fp4uzDCt_p-JplXbhBSvpN2VIEMuo",
      authDomain: "fire-school-system.firebaseapp.com",
      databaseURL: "https://fire-school-system-default-rtdb.asia-southeast1.firebasedatabase.app", 
      projectId: "fire-school-system",
      storageBucket: "fire-school-system.appspot.com",
      messagingSenderId: "347824878089",
      appId: "1:347824878089:web:849723e99c9e44c92d3ed8"
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    const HEADERS = ['Roll No.', 'GR No.', 'Grade', 'Section', 'Gender', "Student's first name", 'Father', 'Surname', 'Mother', 'DOB', 'Category', 'Mobile', 'Alt. Mobile', 'Address', 'Aadhar', 'Apaar', 'ChildID', 'FamilyID', 'Religion', 'Sub-caste', "Father's Aadhar", "Mother's Aadhar", 'Email', 'Adm. Date', 'Adm. in Grade', 'Previous School'];
    let allStudents = {};
    let currentStudentId = null;

    const $ = (selector) => document.querySelector(selector);
    const $$ = (selector) => document.querySelectorAll(selector);

    document.addEventListener('DOMContentLoaded', () => {
      buildStaticParts();
      setupEventListeners();
      const studentsRef = database.ref('students');
      studentsRef.on('value', (snapshot) => {
        allStudents = snapshot.val() || {};
        populateFilters();
        renderFilteredStudents(); 
        showLoader(false);
      }, (error) => {
          console.error("Firebase Error:", error);
          $('#no-data-msg').textContent = "Error: Cannot connect. Check Firebase Rules.";
          showLoader(false);
      });
    });

    function renderFilteredStudents() {
      const grade = $('#grade-select').value; const section = $('#section-select').value;
      const tbody = $('#student-table tbody'); tbody.innerHTML = '';
      if (!grade || !section) {
        $('#data-container').style.display = 'none'; $('#no-data-msg').style.display = 'block'; $('#no-data-msg').textContent = "Please select a Grade and Section.";
        if (Object.keys(allStudents).length === 0) $('#no-data-msg').textContent = "No students found. Use '+ Add Student' to begin."; return;
      }
      const studentArray = Object.keys(allStudents).map(key => ({ id: key, ...allStudents[key] }));
      let filtered = studentArray.filter(s => s.Grade === grade && s.Section === section).sort((a, b) => (a["Student's first name"] || '').localeCompare(b["Student's first name"] || ''));
      if (filtered.length > 0) {
        filtered.forEach((student, index) => {
          student['Roll No.'] = index + 1;
          const row = tbody.insertRow();
          row.innerHTML = HEADERS.map(h => `<td>${student[h] || ''}</td>`).join('') + `<td class="action-cell"><button class="btn btn-edit" onclick="openEditModal('${student.id}')">Edit</button><button class="btn btn-delete" onclick="deleteStudent('${student.id}')">Delete</button></td>`;
        });
        $('#data-container').style.display = 'block'; $('#no-data-msg').style.display = 'none';
      } else {
        $('#data-container').style.display = 'none'; $('#no-data-msg').style.display = 'block'; $('#no-data-msg').textContent = "No students found for this class.";
      }
    }

    function saveStudent() {
      const studentData = {};
      const inputs = $$('#student-form-container input');
      inputs.forEach(input => {
        studentData[input.name] = input.value;
      });
      
      const promise = currentStudentId ? database.ref('students/' + currentStudentId).update(studentData) : database.ref('students').push(studentData);
      promise.then(() => { 
          alert('SUCCESS: Data saved to Firebase!'); 
          closeModal($('#student-modal')); 
      }).catch(error => alert('FIREBASE SAVE ERROR: ' + error.message));
    }

    function setupEventListeners() {
      $('#grade-select').addEventListener('change', renderFilteredStudents);
      $('#section-select').addEventListener('change', renderFilteredStudents);
      $('#add-student-btn').addEventListener('click', openAddModal);
      // **YAHAN HAI ASLI FIX: SAVE BUTTON PAR DIRECT CLICK LISTENER**
      $('#save-student-btn').addEventListener('click', saveStudent);
      $$('.close-btn').forEach(btn => btn.addEventListener('click', () => closeModal(btn.closest('.modal'))));
    }

    // Baaki ke helper functions
    function populateFilters() { const students = Object.values(allStudents); const grades = [...new Set(students.map(s => s.Grade).filter(Boolean))].sort(); const sections = [...new Set(students.map(s => s.Section).filter(Boolean))].sort(); populateSelect($('#grade-select'), grades, 'Select Grade'); populateSelect($('#section-select'), sections, 'Select Section'); }
    window.deleteStudent = (id) => { if (confirm('Are you sure?')) database.ref('students/' + id).remove(); }
    function buildStaticParts() { $('#student-table thead').innerHTML = `<tr><th>${HEADERS.join('</th><th>')}</th><th>Actions</th></tr>`; $('#student-form-container .form-grid').innerHTML = HEADERS.filter(h => h !== 'Roll No.').map(header => { let label = (header === "Student's first name") ? "First Name" : header; return `<div class="form-group"><label>${label}</label><input type="text" name="${header}"></div>`; }).join(''); }
    function openAddModal() { currentStudentId = null; $('#modal-title').textContent = 'Add New Student'; $$('#student-form-container input').forEach(input => input.value = ''); openModal($('#student-modal')); }
    window.openEditModal = (id) => { currentStudentId = id; const student = allStudents[id]; $('#modal-title').textContent = 'Edit Student'; const inputs = $$('#student-form-container input'); inputs.forEach(input => { input.value = student[input.name] || ''; }); openModal($('#student-modal')); }
    function populateSelect(el, items, text) { const val = el.value; el.innerHTML = `<option value="">-- ${text} --</option>`; items.forEach(i => el.add(new Option(i, i))); if (items.includes(val)) el.value = val; }
    function openModal(modal) { modal.style.display = 'block'; }
    function closeModal(modal) { modal.style.display = 'none'; }
    function showLoader(show) { $('#loader').style.display = show ? 'block' : 'none'; }
  </script>
</body>
</html>
