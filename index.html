<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fire School System</title>
  
  <!-- ======================= CSS STYLES ======================= -->
  <style>
    :root { --primary-color: #0d6efd; --success-color: #198754; --secondary-color: #6c757d; --danger-color: #dc3545; --light-gray: #f8f9fa; --dark-gray: #343a40; --border-color: #dee2e6; --box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: var(--light-gray); margin: 0; color: var(--dark-gray); }
    .container { max-width: 1300px; margin: 20px auto; padding: 20px; background: #fff; border-radius: 8px; box-shadow: var(--box-shadow); }
    header { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--border-color); padding-bottom: 15px; margin-bottom: 20px; }
    header h1 { margin: 0; color: var(--primary-color); }
    .actions { display: flex; gap: 10px; }
    .btn { padding: 10px 18px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px; }
    .btn:hover { opacity: 0.9; transform: translateY(-1px); }
    .btn-primary { background-color: var(--primary-color); color: white; } .btn-success { background-color: var(--success-color); color: white; } .btn-secondary { background-color: var(--secondary-color); color: white; } .btn-danger { background-color: var(--danger-color); color: white; } .btn-edit { background-color: #ffc107; color: black; padding: 5px 10px; font-size: 12px; } .btn-delete { background-color: #dc3545; color: white; padding: 5px 10px; font-size: 12px; }
    .filters { display: flex; gap: 20px; margin-bottom: 20px; } .filter-group { display: flex; flex-direction: column; } .filter-group label { margin-bottom: 5px; font-size: 14px; font-weight: 500; }
    select, input[type="file"] { padding: 8px; border-radius: 5px; border: 1px solid var(--border-color); min-width: 200px; }
    .table-wrapper { overflow-x: auto; }
    #student-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    #student-table th, #student-table td { border: 1px solid var(--border-color); padding: 10px 12px; text-align: left; white-space: nowrap; }
    #student-table th { background-color: var(--primary-color); color: white; font-weight: 600; position: sticky; top: 0; }
    #student-table tbody tr:nth-child(even) { background-color: var(--light-gray); } #student-table tbody tr:hover { background-color: #e9ecef; }
    .action-cell { display: flex; gap: 8px; }
    .loader { border: 8px solid #f3f3f3; border-top: 8px solid var(--primary-color); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 40px auto; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .no-data-msg { text-align: center; color: #888; font-style: italic; padding: 40px; }
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
    .modal-content { background-color: #fefefe; margin: 5% auto; padding: 25px; border: 1px solid #888; width: 80%; max-width: 800px; border-radius: 8px; box-shadow: var(--box-shadow); }
    .close-btn { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; } .close-btn:hover, .close-btn:focus { color: black; }
    #student-form { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px; margin-top: 20px; max-height: 60vh; overflow-y:auto; padding:5px; }
    .form-group { display: flex; flex-direction: column; } .form-group label { margin-bottom: 5px; font-size: 14px; }
    .form-group input, .form-group select { padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 14px; width: 100%; box-sizing: border-box; }
    .modal-actions { margin-top: 25px; text-align: right; }
    #export-checkbox-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; max-height: 350px; overflow-y: auto; border: 1px solid var(--border-color); padding: 15px; border-radius: 5px; margin-top: 15px; }
    .checkbox-item { display: flex; align-items: center; } .checkbox-item input { margin-right: 10px; }
  </style>
</head>
<body>
  <!-- ======================= HTML BODY ======================= -->
  <div class="container">
    <header>
      <h1>Fire School System</h1>
      <div class="actions">
        <button id="add-student-btn" class="btn btn-primary">+ Add Student</button>
        <button id="bulk-add-btn" class="btn btn-success">Bulk Add</button>
        <button id="sort-export-btn" class="btn btn-secondary">Sort & Export</button>
      </div>
    </header>
    <div class="filters">
      <div class="filter-group"> <label for="grade-select">Select Grade:</label> <select id="grade-select"></select> </div>
      <div class="filter-group"> <label for="section-select">Select Section:</label> <select id="section-select"></select> </div>
    </div>
    <div id="loader" class="loader"></div>
    <div id="data-container" style="display: none;">
      <div class="table-wrapper"> <table id="student-table"> <thead></thead> <tbody></tbody> </table> </div>
    </div>
    <p id="no-data-msg" style="display: none;">Loading data...</p>
  </div>

  <!-- Modals -->
  <div id="student-modal" class="modal">
    <div class="modal-content"> <span class="close-btn">&times;</span> <h2 id="modal-title">Add New Student</h2> <form id="student-form"></form> <div class="modal-actions"> <button id="save-student-btn" class="btn btn-primary">Save</button> </div> </div>
  </div>
  <div id="bulk-modal" class="modal">
    <div class="modal-content"> <span class="close-btn">&times;</span> <h2>Bulk Add Students</h2> <p>Upload a CSV file. <a href="https://docs.google.com/spreadsheets/d/1X_c1A5zL8Z-vJtGq8W7K6F4Y3z2N1R0O9B_vA7hC4E/export?format=csv" download="template.csv">Download Template</a></p> <input type="file" id="csv-file-input" accept=".csv" style="margin-top: 15px;"> <div class="modal-actions"> <button id="upload-csv-btn" class="btn btn-success">Upload</button> </div> </div>
  </div>
  <div id="export-modal" class="modal">
    <div class="modal-content"> <span class="close-btn">&times;</span> <h2>Select Columns to Export</h2> <p>Select columns to export from the current view.</p> <div id="export-checkbox-container"></div> <div class="modal-actions"> <button id="export-csv-btn" class="btn btn-success">Download CSV</button> </div> </div>
  </div>

  <!-- Firebase and PapaParse Libraries -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

  <!-- ======================= JAVASCRIPT LOGIC ======================= -->
  <script>
    // Firebase Configuration (with CORRECT databaseURL)
    const firebaseConfig = {
      apiKey: "AIzaSyBZB9fp4uzDCt_p-JplXbhBSvpN2VIEMuo",
      authDomain: "fire-school-system.firebaseapp.com",
      // YEH SABSE ZAROORI FIX HAI. AAPKA DATABASE ASIA MEIN HAI.
      databaseURL: "https://fire-school-system-default-rtdb.asia-southeast1.firebasedatabase.app", 
      projectId: "fire-school-system",
      storageBucket: "fire-school-system.appspot.com",
      messagingSenderId: "347824878089",
      appId: "1:347824878089:web:849723e99c9e44c92d3ed8"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // Global Variables
    const HEADERS = ['Roll No.', 'GR No.', 'Grade', 'Section', 'Gender', "Student's first name", 'Father', 'Surname', 'Mother', 'DOB', 'Category', 'Mobile', 'Alt. Mobile', 'Address', 'Aadhar', 'Apaar', 'ChildID', 'FamilyID', 'Religion', 'Sub-caste', "Father's Aadhar", "Mother's Aadhar", 'Email', 'Adm. Date', 'Adm. in Grade', 'Previous School'];
    let allStudents = {};
    let currentStudentId = null;

    // DOM Elements
    const gradeSelect = document.getElementById('grade-select');
    const sectionSelect = document.getElementById('section-select');
    const studentTableBody = document.querySelector('#student-table tbody');
    const studentTableHead = document.querySelector('#student-table thead');
    const loader = document.getElementById('loader');
    const dataContainer = document.getElementById('data-container');
    const noDataMsg = document.getElementById('no-data-msg');
    const studentForm = document.getElementById('student-form');
    
    // Main Function
    document.addEventListener('DOMContentLoaded', () => {
      buildStaticParts();
      setupEventListeners();
      
      const studentsRef = database.ref('students');
      studentsRef.on('value', (snapshot) => {
        allStudents = snapshot.val() || {};
        populateFilters();
        renderFilteredStudents(); 
        showLoader(false);
      }, (error) => {
          console.error("Firebase Read Error:", error);
          noDataMsg.textContent = "Error: Cannot connect. Please check Firebase Rules and Authorized Domains.";
          noDataMsg.style.display = 'block';
          showLoader(false);
      });
    });

    function renderFilteredStudents() {
      const selectedGrade = gradeSelect.value;
      const selectedSection = sectionSelect.value;
      studentTableBody.innerHTML = '';
      
      if (!selectedGrade || !selectedSection) {
        dataContainer.style.display = 'none';
        noDataMsg.textContent = "Please select a Grade and Section.";
        if (Object.keys(allStudents).length === 0) noDataMsg.textContent = "No students found. Use '+ Add Student' to begin.";
        noDataMsg.style.display = 'block';
        return;
      }
      const studentArray = Object.keys(allStudents).map(key => ({ id: key, ...allStudents[key] }));
      let filteredStudents = studentArray.filter(s => s.Grade === selectedGrade && s.Section === selectedSection);
      filteredStudents.sort((a, b) => (a["Student's first name"] || '').localeCompare(b["Student's first name"] || ''));
      
      if (filteredStudents.length > 0) {
        filteredStudents.forEach((student, index) => {
          student['Roll No.'] = index + 1;
          const row = studentTableBody.insertRow();
          let rowHtml = HEADERS.map(header => `<td>${student[header] || ''}</td>`).join('');
          rowHtml += `<td class="action-cell"> <button class="btn btn-edit" onclick="openEditModal('${student.id}')">Edit</button> <button class="btn btn-delete" onclick="deleteStudent('${student.id}')">Delete</button> </td>`;
          row.innerHTML = rowHtml;
        });
        dataContainer.style.display = 'block'; noDataMsg.style.display = 'none';
      } else {
        dataContainer.style.display = 'none'; noDataMsg.textContent = "No students found for this class."; noDataMsg.style.display = 'block';
      }
    }
    function populateFilters() {
      const students = Object.values(allStudents);
      const grades = [...new Set(students.map(s => s.Grade).filter(Boolean))].sort();
      const sections = [...new Set(students.map(s => s.Section).filter(Boolean))].sort();
      populateSelect(gradeSelect, grades, 'Select Grade');
      populateSelect(sectionSelect, sections, 'Select Section');
    }
    function saveStudent(event) {
      event.preventDefault();
      const formData = new FormData(studentForm);
      const studentData = {};
      HEADERS.forEach(header => { if (header !== 'Roll No.') studentData[header] = formData.get(header); });
      const promise = currentStudentId ? database.ref('students/' + currentStudentId).update(studentData) : database.ref('students').push(studentData);
      promise.then(() => { alert('Saved!'); closeModal(document.getElementById('student-modal')); }).catch(error => alert('Error: ' + error.message));
    }
    window.deleteStudent = (studentId) => { if (confirm('Are you sure?')) database.ref('students/' + studentId).remove(); }
    function buildStaticParts() {
      studentTableHead.innerHTML = `<tr><th>${HEADERS.join('</th><th>')}</th><th>Actions</th></tr>`;
      studentForm.innerHTML = HEADERS.filter(h => h !== 'Roll No.').map(header => {
        let label = (header === "Student's first name") ? "First Name" : header;
        return `<div class="form-group"><label>${label}</label><input type="text" name="${header}"></div>`;
      }).join('');
      document.getElementById('export-checkbox-container').innerHTML = HEADERS.map(h => `<label class="checkbox-item"><input type="checkbox" value="${h}" checked>${h}</label>`).join('');
    }
    function setupEventListeners() {
      gradeSelect.addEventListener('change', renderFilteredStudents);
      sectionSelect.addEventListener('change', renderFilteredStudents);
      document.getElementById('add-student-btn').addEventListener('click', openAddModal);
      document.getElementById('save-student-btn').addEventListener('click', saveStudent);
      document.querySelectorAll('.close-btn').forEach(btn => btn.addEventListener('click', () => closeModal(btn.closest('.modal'))));
    }
    function openAddModal() {
      currentStudentId = null;
      document.getElementById('modal-title').textContent = 'Add New Student';
      studentForm.reset();
      openModal(document.getElementById('student-modal'));
    }
    window.openEditModal = (studentId) => {
      currentStudentId = studentId;
      const student = allStudents[studentId];
      document.getElementById('modal-title').textContent = 'Edit Student';
      HEADERS.forEach(header => {
        if(header !== 'Roll No.' && studentForm.elements[header]) studentForm.elements[header].value = student[header] || '';
      });
      openModal(document.getElementById('student-modal'));
    }
    function populateSelect(selectEl, items, defaultText) {
      const currentValue = selectEl.value;
      selectEl.innerHTML = `<option value="">-- ${defaultText} --</option>`;
      items.forEach(item => selectEl.add(new Option(item, item)));
      if (items.includes(currentValue)) selectEl.value = currentValue;
    }
    function openModal(modal) { modal.style.display = 'block'; }
    function closeModal(modal) { modal.style.display = 'none'; }
    function showLoader(show) { loader.style.display = show ? 'block' : 'none'; }
  </script>
</body>
</html>
